
<!DOCTYPE html>
<html lang="fr-FR">
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Blog d&#39;un artisan développeur">
    <title>Un serveur MongoDB sécurisé sur Docker - Blog d&#39;un artisan développeur</title>
    <meta name="author" content="Pierre PIRONIN">
    
    
        <link rel="alternative" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <meta name="description" content="Je vous propose dans cet article de jouer un peu avec Docker pour monter une instance MongoDB sur un Ubuntu Server 14.04 et la rendre accessible depuis internet. Le but étant de fournir un base de don">
<meta property="og:type" content="blog">
<meta property="og:title" content="Un serveur MongoDB sécurisé sur Docker">
<meta property="og:url" content="http://pierrepironin.fr/docker-et-mongodb/index.html">
<meta property="og:site_name" content="Blog d'un artisan développeur">
<meta property="og:description" content="Je vous propose dans cet article de jouer un peu avec Docker pour monter une instance MongoDB sur un Ubuntu Server 14.04 et la rendre accessible depuis internet. Le but étant de fournir un base de don">
<meta property="og:updated_time" content="2016-10-16T18:05:43.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Un serveur MongoDB sécurisé sur Docker">
<meta name="twitter:description" content="Je vous propose dans cet article de jouer un peu avec Docker pour monter une instance MongoDB sur un Ubuntu Server 14.04 et la rendre accessible depuis internet. Le but étant de fournir un base de don">
<meta name="twitter:creator" content="@PierrePIRONIN">
    
    
    
        <meta property="og:image" content="https://www.gravatar.com/avatar/7e1107690f34c749ba1ca5b05b7e18c5?s=640"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style.min.css">
    <!--STYLES END-->
    
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-70817000-1']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
    

<header id="header" data-behavior="3">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">Blog d&#39;un artisan développeur</a>
    </h1>
    
        
            <a  class="header-right-picture "
                href="#about">
        
        
            <img class="header-picture" src="https://www.gravatar.com/avatar/7e1107690f34c749ba1ca5b05b7e18c5?s=90"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->


    

<nav id="sidebar" data-behavior="3">
    
        <div class="sidebar-profile">
            <a href="/#about">
                    <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/7e1107690f34c749ba1ca5b05b7e18c5?s=110"/>
            </a>
            <span class="sidebar-profile-name">Pierre PIRONIN</span>
        </div>
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/ "
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">Accueil</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-categories"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">Categories</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-tags"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">Tags</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-archives"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                    <span class="sidebar-button-desc">Archive</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link st-search-show-outputs"
                         href="#search"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-search"></i>
                    <span class="sidebar-button-desc">Rechercher</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="#about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                    <span class="sidebar-button-desc">À propos</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://github.com/PierrePIRONIN" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://twitter.com/PierrePIRONIN" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
                    <span class="sidebar-button-desc">Twitter</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="http://fr.linkedin.com/in/pierrepironin" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-linkedin"></i>
                    <span class="sidebar-button-desc">LinkedIn</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="mailto:pierre@pierrepironin.fr" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-envelope-o"></i>
                    <span class="sidebar-button-desc">Mail</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/atom.xml"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
                    <span class="sidebar-button-desc">RSS</span>
                </a>
        </li>
        
    </ul>
    
</nav>

            
            <div id="main" data-behavior="3"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            Un serveur MongoDB sécurisé sur Docker
        </h1>
    
    <div class="post-meta">
    <time itemprop="datePublished" content="Fri Apr 10 2015 20:54:38 GMT+0200">
	
		    10 avril 2015
    	
    </time>
    
        <span>dans </span>
        
    <a class="category-link" href="/categories/Sys-Admin/">Sys Admin</a>


    
</div>
</div>
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <p><div style="text-align: justify; text-justify: inter-word"><br>Je vous propose dans cet article de jouer un peu avec <a href="https://www.docker.com/" title="Docker" target="_blank" rel="external">Docker</a> pour monter une instance <a href="http://pierrepironin.fr/lava-jug-soiree-et-workshop-mongodb/" title="Lava JUG – Soirée et workshop MongoDB">MongoDB</a> sur un <a href="http://doc.ubuntu-fr.org/ubuntu_server" title="Ubuntu Server" target="_blank" rel="external">Ubuntu Server 14.04</a> et la rendre accessible depuis internet. Le but étant de fournir un base de données partagée entre plusieurs développeurs pour un projet assez simple.</div></p>
<p>Nous verrons donc comment récupérer une image Docker de Mongo qui va bien à travers <a href="https://hub.docker.com/" title="Docker Hub" target="_blank" rel="external">Docker Hub</a> et comment mettre en place quelques mécanismes de sécurité de base (authentification + connexions SSL).</p>
<p>L’article peut paraître assez long mais pas de panique, c’est dû aux explications et aux exemples. Le nombre de commandes à taper n’est pas très important.</p>
<p>C’est parti !</p>
<a id="more"></a>
<h1 id="table-of-contents">Table des matières</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Installer-Docker"><span class="toc-text">Installer Docker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Recuperer-une-image-MongoDB"><span class="toc-text">Récupérer une image MongoDB</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Creer-des-dossiers-permanents-pour-les-bases-de-donnees-MongoDB"><span class="toc-text">Créer des dossiers permanents pour les bases de données MongoDB</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lancer-le-server-MongoDB-en-mode-authentifie"><span class="toc-text">Lancer le server MongoDB en mode authentifié</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lancer-un-client-Mongo-pour-creer-un-super-admin"><span class="toc-text">Lancer un client Mongo pour créer un super-admin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ajouter-un-utilisateur-pour-notre-base-de-donnees"><span class="toc-text">Ajouter un utilisateur pour notre base de données</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Encrypter-notre-connexion-avec-SSL"><span class="toc-text">Encrypter notre connexion avec SSL</span></a></li></ol>
<h2 id="Installer-Docker"><a href="#Installer-Docker" class="headerlink" title="Installer Docker"></a>Installer Docker</h2><p>La première chose à faire est d’installer Docker sur notre Ubuntu Server.</p>
<p>Docker étant un projet qui bouge vite (très vite !), on n’utilisera pas directement un <em>apt-get install</em> classique mais la ligne de commande suivante :<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">wget -qO- https://get.docker.com/ | sh</div></pre></td></tr></table></figure></p>
<p>Après avoir téléchargé pas mal de choses, Docker devrait être installé correctement. On peut tester avec :<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sudo docker ps</div></pre></td></tr></table></figure></p>
<p>Si ce n’est pas le cas et que vous avez une erreur du style<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">FATA[0000] Get http:///var/run/docker.sock/v1.17/containers/json: dial unix /var/run/docker.sock: no such file </div><div class="line">or directory. </div><div class="line">Are you trying to connect to a TLS-enabled daemon without TLS?</div></pre></td></tr></table></figure></p>
<p>il faut un peu bidouiller en lançant une installation par apt classique puis une suppression par apt et enfin une réinstallation par la méthode ci-dessus…<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sudo apt-get install docker.io</div><div class="line">sudo docker version</div><div class="line">sudo apt-get remove docker.io</div><div class="line">wget -qO- https://get.docker.com/ | sh</div></pre></td></tr></table></figure></p>
<p>Par défaut Docker s’exécute à travers un sudo mais on peut se simplifier un peu la vie en ajoutant notre utilisateur à un groupe docker (ex avec mon login <em>pierrot</em>):<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sudo usermod -aG docker pierrot</div></pre></td></tr></table></figure></p>
<p>On peut vérifier la bonne installation avec :<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">docker run hello-world</div></pre></td></tr></table></figure></p>
<p>Si tout va bien vous devriez voir les lignes suivantes :<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">pierrot@dev:~$ docker run hello-world</div><div class="line">    Unable to find image &apos;hello-world:latest&apos; locally</div><div class="line">    31cbccb51277: Pull complete </div><div class="line">    e45a5af57b00: Pull complete </div><div class="line">    511136ea3c5a: Already exists </div><div class="line">    hello-world:latest: The image you are pulling has been verified. Important: image verification is a tech preview feature and should not be relied on to provide security.</div><div class="line">    Status: Downloaded newer image for hello-world:latest</div><div class="line">    Hello from Docker.</div><div class="line">    This message shows that your installation appears to be working correctly.</div><div class="line"></div><div class="line">    To generate this message, Docker took the following steps:</div><div class="line">        1. The Docker client contacted the Docker daemon.</div><div class="line">        2. The Docker daemon pulled the &quot;hello-world&quot; image from the Docker Hub.</div><div class="line">            (Assuming it was not already locally available.)</div><div class="line">        3. The Docker daemon created a new container from that image which runs the</div><div class="line">            executable that produces the output you are currently reading.</div><div class="line">        4. The Docker daemon streamed that output to the Docker client, which sent it</div><div class="line">            to your terminal.</div><div class="line"></div><div class="line">    To try something more ambitious, you can run an Ubuntu container with:</div><div class="line">    $ docker run -it ubuntu bash</div><div class="line"></div><div class="line">    For more examples and ideas, visit:</div><div class="line">    http://docs.docker.com/userguide/</div></pre></td></tr></table></figure></p>
<p>sources : <a href="https://docs.docker.com/installation/ubuntulinux" title="Docker on Ubuntu" target="_blank" rel="external">https://docs.docker.com/installation/ubuntulinux</a></p>
<h2 id="Recuperer-une-image-MongoDB"><a href="#Recuperer-une-image-MongoDB" class="headerlink" title="Récupérer une image MongoDB"></a>Récupérer une image MongoDB</h2><p>Un des gros avantages de Docker est son Hub qui met à disposition des milliers d’images prêtes à l’utilisation.</p>
<p>On va donc récupérer une image officielle Mongo dans sa dernière version (à ce jour 3.0) :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">docker pull mongo:latest</div></pre></td></tr></table></figure>
<p>Attention de bien spécifier un tag (ici <em>latest</em>) sinon Docker récupérera TOUTES les versions disponibles ! Et ça en fait quelques <a href="https://registry.hub.docker.com/_/mongo/tags/manage/" title="Mongo Docker tags" target="_blank" rel="external">unes</a>, je le sais, je n’avais pas mis de tag lors de mes premiers tests….</p>
<p>Docker récupère l’image Mongo :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">pierrot@dev:~$ docker pull mongo:latest</div><div class="line">    4f903438061c: Pull complete </div><div class="line">    1265e16d0c28: Pull complete </div><div class="line">    ...</div><div class="line">    9552b2f0723b: Pull complete </div><div class="line">    511136ea3c5a: Already exists </div><div class="line">    mongo:latest: The image you are pulling has been verified. Important: image verification is a tech preview feature and should not be relied on to provide security.</div><div class="line">    Status: Downloaded newer image for mongo:latest</div></pre></td></tr></table></figure>
<p>Il est toujours intéressant de jeter un œil à ce qui se passe en coulisse, on peut donc aller décortiquer le <a href="https://github.com/docker-library/mongo/blob/b1c4c5028bd10fe01ddd3fbcdb4b0828580c14e0/3.0/Dockerfile" title="DockerFile for Mongo 3.0" target="_blank" rel="external">DockerFile</a> associé à l’image téléchargée.</p>
<p>sources : <a href="https://registry.hub.docker.com/_/mongo/" title="Docker repository for Mongo" target="_blank" rel="external">https://registry.hub.docker.com/_/mongo/</a></p>
<h2 id="Creer-des-dossiers-permanents-pour-les-bases-de-donnees-MongoDB"><a href="#Creer-des-dossiers-permanents-pour-les-bases-de-donnees-MongoDB" class="headerlink" title="Créer des dossiers permanents pour les bases de données MongoDB"></a>Créer des dossiers permanents pour les bases de données MongoDB</h2><p>Afin de pouvoirs sauvegarder les bases de données, on spécifiera à Docker un binding de /data/db (qui est le lieu de stockage par défaut de MongoDB) vers un chemin local.</p>
<p>Si ce n’est pas très clair, pas de soucis ça le sera quelques lignes plus bas. Pour l’instant on crée juste le dossier qui va bien :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sudo mkdir -p /opt/mongodb/db</div></pre></td></tr></table></figure>
<h2 id="Lancer-le-server-MongoDB-en-mode-authentifie"><a href="#Lancer-le-server-MongoDB-en-mode-authentifie" class="headerlink" title="Lancer le server MongoDB en mode authentifié"></a>Lancer le server MongoDB en mode authentifié</h2><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">docker run -p 27017:27017 -v /opt/mongodb/db:/data/db --name my-mongo-dev -d mongo mongod --auth</div></pre></td></tr></table></figure>
<p>Explications :</p>
<ul>
<li><em>docker run</em> =&gt; on crée un container</li>
<li><em>-p 27017:27017</em> =&gt; dont le port 27017 (port par défaut de mongod) sera accessible en dehors du container</li>
<li><em>-v &lt;local_rep&gt;:&lt;container_rep&gt;</em> =&gt; le dossier /data/db (localisation des bases MongoDB) sera en fait un “lien” vers le dossier que l’on a créé juste au-dessus</li>
<li><em>–name my-mongo-dev</em> =&gt; nom personnalisé du container</li>
<li><em>-d</em> =&gt; le container sera lancé en mode démon au sens linux donc en tâche de fond</li>
<li><em>mongo</em> =&gt; nom de l’image associée au container (i.e. celle que l’on a téléchargé plus tôt)</li>
<li><em>mongod –auth</em> =&gt; lancement du serveur mongo en mode authentification requise</li>
</ul>
<p>Si tout va bien, un <em>docker ps</em> nous affiche notre container et un <em>docker logs</em> nous donne les logs de démarrage de notre serveur MongoDB :<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">pierrot@dev:~$ docker run -p 27017:27017 -v /opt/mongodb/db:/data/db --name my-mongo-dev -d mongo mongod --auth</div><div class="line">    5e90c0b309580aa47f1a6404e43071e6b50198d0ea8b383e4c32cdad18ddc990</div><div class="line"></div><div class="line">pierrot@dev:~$ docker ps</div><div class="line">    CONTAINER ID        IMAGE               COMMAND                CREATED             STATUS              PORTS                      NAMES</div><div class="line">    5e90c0b30958        mongo:latest        &quot;/entrypoint.sh mong   5 seconds ago       Up 5 seconds        0.0.0.0:27017-&amp;gt;27017/tcp   my-mongo-dev   </div><div class="line"></div><div class="line">pierrot@dev:~$ docker logs my-mongo-dev</div><div class="line">    2015-04-06T17:24:05.787+0000 I JOURNAL  [initandlisten] journal dir=/data/db/journal</div><div class="line">    2015-04-06T17:24:05.788+0000 I JOURNAL  [initandlisten] recover : no journal files present, no recovery needed</div><div class="line">    2015-04-06T17:24:07.636+0000 I JOURNAL  [initandlisten] preallocateIsFaster=true 17.56</div><div class="line">    ...</div><div class="line">    2015-04-06T17:24:41.419+0000 I STORAGE  [FileAllocator] done allocating datafile /data/db/local.0, size: 64MB,  took 0.016 secs</div><div class="line">    2015-04-06T17:24:41.434+0000 I NETWORK  [initandlisten] waiting for connections on port 27017</div></pre></td></tr></table></figure></p>
<p>sources :</p>
<ul>
<li><a href="https://registry.hub.docker.com/u/dockerfile/mongodb/" title="Docker Hub previous Mongo" target="_blank" rel="external">https://registry.hub.docker.com/u/dockerfile/mongodb/</a></li>
<li><a href="https://registry.hub.docker.com/_/mongo/" title="Docker repository for Mongo" target="_blank" rel="external">https://registry.hub.docker.com/_/mongo/</a></li>
</ul>
<h2 id="Lancer-un-client-Mongo-pour-creer-un-super-admin"><a href="#Lancer-un-client-Mongo-pour-creer-un-super-admin" class="headerlink" title="Lancer un client Mongo pour créer un super-admin"></a>Lancer un client Mongo pour créer un super-admin</h2><p>À ce stade, il est possible de se connecter à notre serveur de l’extérieur mais nous n’aurons accès à aucune collection (i.e. table) ni en lecture ni en écriture (à part la collection test).</p>
<p>Pour remédier à cela, il nous faut créer un utilisateur “super-admin” qui servira à créer d’autres utilisateurs. Cela se fait avec un client mongo lancé sur le <strong>même système</strong> que le serveur mongod grâce à la “<a href="http://docs.mongodb.org/manual/core/authentication/#localhost-exception" title="Mongo Localhost Exception" target="_blank" rel="external">localhost exception</a>“.</p>
<p>Mais comment accéder au même système que notre serveur qui n’est autre que le container docker lancé en mode démon ? Le plus simple est d’utiliser la commande <em>exec</em> introduite avec la version 1.3 de Docker afin de lancer un client mongo dans le même container :<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">docker exec -it my-mongo-dev mongo</div></pre></td></tr></table></figure></p>
<p>Ensuite, on crée notre super-admin dans la console mongo :<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&gt; use admin</div><div class="line">switched to db admin</div><div class="line">&gt; db.createUser(</div><div class="line">... &#123;</div><div class="line">... user: &quot;siteUserAdmin&quot;,</div><div class="line">... pwd: &quot;unPasswordQuiVaBien&quot;,</div><div class="line">... roles: [&#123;role: &quot;userAdminAnyDatabase&quot;, db: &quot;admin&quot;&#125;]</div><div class="line">... &#125;</div><div class="line">... )</div><div class="line">Successfully added user: &#123;</div><div class="line">    &quot;user&quot; : &quot;siteUserAdmin&quot;,</div><div class="line">    &quot;roles&quot; : [</div><div class="line">        &#123;</div><div class="line">        &quot;role&quot; : &quot;userAdminAnyDatabase&quot;,</div><div class="line">        &quot;db&quot; : &quot;admin&quot;</div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Nous voilà prêt pour créer d’autres utilisateurs.<br>sources :</p>
<ul>
<li><a href="http://serverfault.com/questions/594281/how-can-i-override-cmd-when-running-a-docker-image" title="Docker exec" target="_blank" rel="external">http://serverfault.com/questions/594281/how-can-i-override-cmd-when-running-a-docker-image</a></li>
<li><a href="http://docs.mongodb.org/manual/administration/security/" title="Mongo Security" target="_blank" rel="external">http://docs.mongodb.org/manual/administration/security/</a></li>
<li><a href="http://docs.mongodb.org/manual/tutorial/enable-authentication/" title="Mongo enable authentification" target="_blank" rel="external">http://docs.mongodb.org/manual/tutorial/enable-authentication/</a></li>
</ul>
<h2 id="Ajouter-un-utilisateur-pour-notre-base-de-donnees"><a href="#Ajouter-un-utilisateur-pour-notre-base-de-donnees" class="headerlink" title="Ajouter un utilisateur pour notre base de données"></a>Ajouter un utilisateur pour notre base de données</h2><p>Il vaut mieux éviter de travailler directement avec le super-admin, on ne va l’utiliser que pour créer d’autres utilisateurs.</p>
<p>Pour avoir quelque chose d’assez simple, on ne va créer qu’un seul utilisateur qui aurait accès en lecture/écriture sur toute la base de données avec laquelle on veut travailler.</p>
<p>On commence par lancer un client mongo sur n’importe quelle machine en se connectant avec notre super-admin :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">mongo &lt;ip_server&gt; -u siteUserAdmin -p unPasswordQuiVaBien --authenticationDatabase admin</div></pre></td></tr></table></figure>
<p>Puis, on switche sur la base de données que l’on veut utiliser (ici kanban) et on crée un admin :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&gt; use kanban</div><div class="line">    switched to db kanban</div><div class="line">&gt; db.createUser(</div><div class="line">... &#123;</div><div class="line">... user: &quot;kanbanUser&quot;,</div><div class="line">... pwd: &quot;unAutrePasswordQuiVaBien&quot;,</div><div class="line">... roles: [&quot;dbOwner&quot;]</div><div class="line">... &#125;</div><div class="line">... )</div><div class="line">Successfully added user: &#123; &quot;user&quot; : &quot;kanbanUser&quot;, &quot;roles&quot; : [ &quot;dbOwner&quot; ] &#125;</div></pre></td></tr></table></figure>
<p>On peut maintenant faire le test en se connectant directement sur la base kanban avec notre nouvel utilisateur :<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">mongo &lt;ip_server&gt;/kanban -u kanbanUser -p unAutrePasswordQuiVaBien --authenticationDatabase kanban</div><div class="line"></div><div class="line">&gt; db.card.insert(</div><div class="line">... &#123;</div><div class="line">... name: &quot;test&quot;</div><div class="line">... &#125;</div><div class="line">... )</div><div class="line">WriteResult(&#123; &quot;nInserted&quot; : 1 &#125;)</div><div class="line">&gt; db.card.find()</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5522d47b07994c60f49b8674&quot;), &quot;name&quot; : &quot;test&quot; &#125;</div></pre></td></tr></table></figure></p>
<p>On peut faire le test en se connectant sans les informations du kanbanUser et voir que l’accès est bien restreint :<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">mongo &lt;ip_server&gt;/kanban</div><div class="line"></div><div class="line">&gt; db.card.find()</div><div class="line">Error: error: &#123; &quot;$err&quot; : &quot;not authorized for query on kanban.card&quot;, &quot;code&quot; : 13 &#125;</div></pre></td></tr></table></figure></p>
<p>sources : <a href="http://docs.mongodb.org/manual/tutorial/add-user-to-database/" title="Add user Mongo" target="_blank" rel="external">http://docs.mongodb.org/manual/tutorial/add-user-to-database/</a></p>
<h2 id="Encrypter-notre-connexion-avec-SSL"><a href="#Encrypter-notre-connexion-avec-SSL" class="headerlink" title="Encrypter notre connexion avec SSL"></a>Encrypter notre connexion avec SSL</h2><p>Le serveur MongoDB peut être lancé pour accepter des connexions cryptées avec SSL. Pour cela, il nous faut un certificat d’authentification et comme nous sommes ici en phase de développement, nous allons créer un certificat auto-signé avec <a href="https://www.openssl.org/" title="OpenSSL" target="_blank" rel="external">OpenSSL</a>.</p>
<p>On commence par se placer dans le dossier qui va bien et on passe en root.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">cd /etc/ssl</div><div class="line">sudo su</div></pre></td></tr></table></figure>
<p>Puis on utilise la commande suivante pour générer un certificat et une clé.<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">openssl req -newkey rsa:2048 -new -x509 -days 365 -nodes -out mongodb-cert.crt -keyout mongodb-cert.key</div></pre></td></tr></table></figure></p>
<p>Ensuite on concatène le certificat et la clé dans un fichier .pem et on quitte le mode root.<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">cat mongodb-cert.key mongodb-cert.crt &gt; mongodb.pem</div><div class="line">mkdir -p /opt/mongodb/cert</div><div class="line">cp mongodb.pem /opt/mongodb/cert</div><div class="line">exit</div></pre></td></tr></table></figure></p>
<p>Il faut maintenant ajouter des arguments à notre serveur MongoDB. Comme nous avons fait en sorte de sauvegarder de manière permanente nos bases de données, on peut simplement supprimer le container existant et en recréer un.<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">pierrot@dev:~$ docker stop my-mongo-dev</div><div class="line">    08640a0f3ad8</div><div class="line"></div><div class="line">pierrot@dev:~$ docker rm my-mongo-dev</div><div class="line">    08640a0f3ad8</div><div class="line"></div><div class="line">pierrot@dev:/opt/mongodb$ docker run -p 27017:27017 -v /opt/mongodb/db:/data/db -v /opt/mongodb/cert:/data/cert --name my-mongo-dev -d mongo mongod --auth --sslMode requireSSL --sslPEMKeyFile /data/cert/mongodb.pem</div><div class="line">    9339de3f58786f6f46c25c9af1c3c49151936b10d8578ea9727028f8da77a209</div><div class="line"></div><div class="line">pierrot@dev:/opt/mongodb$ docker logs my-mongo-dev</div><div class="line">    2015-04-09T18:34:41.040+0000 W CONTROL  No SSL certificate validation can be performed since no CA file has been provided; please specify an sslCAFile parameter</div><div class="line">    ...</div><div class="line">    2015-04-09T18:34:41.147+0000 I CONTROL  [initandlisten] options: &#123; net: &#123; ssl: &#123; PEMKeyFile: &quot;/data/cert/mongodb.pem&quot;, mode: &quot;requireSSL&quot; &#125; &#125;, security: &#123; authorization: &quot;enabled&quot; &#125; &#125;</div><div class="line">    2015-04-09T18:34:41.173+0000 I NETWORK  [initandlisten] waiting for connections on port 27017 ssl</div></pre></td></tr></table></figure></p>
<p>Voilà, notre serveur MongoDB utilise une connexion SSL.</p>
<p>Il ne nous reste plus qu’à modifier la façon de lancer notre client MongoDB en ajoutant les arguments qui vont bien pour un certificat auto-signé.<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">mongo &lt;ip_server&gt;/kanban -u kanbanUser -p unAutrePasswordQuiVaBien --authenticationDatabase kanban --ssl --sslAllowInvalidCertificates</div></pre></td></tr></table></figure></p>
<p>sources :</p>
<ul>
<li><a href="http://docs.mongodb.org/manual/tutorial/configure-ssl/" title="MongoDB doc ssl server" target="_blank" rel="external">http://docs.mongodb.org/manual/tutorial/configure-ssl/</a></li>
<li><a href="http://docs.mongodb.org/manual/tutorial/configure-ssl-clients/" title="MongoDB doc ssl client" target="_blank" rel="external">http://docs.mongodb.org/manual/tutorial/configure-ssl-clients/</a><div></div></li>
</ul>

            
                

            
        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGÉ DANS</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/Docker/">Docker</a> <a class="tag tag--primary tag--small t-link" href="/tags/MongoDB/">MongoDB</a> <a class="tag tag--primary tag--small t-link" href="/tags/Ubuntu-Server/">Ubuntu Server</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/lava-jug-bigdata-et-integration-en-entreprise/"  data-tooltip="Lava JUG - Bigdata et intégration en entreprise">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PRÉCÉDENT</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/lava-jug-soiree-et-workshop-mongodb/" data-tooltip="Lava JUG - Soirée et workshop MongoDB">
                
                    <span class="hide-xs hide-sm text-small icon-mr">SUIVANT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://pierrepironin.fr/docker-et-mongodb/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://pierrepironin.fr/docker-et-mongodb/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://pierrepironin.fr/docker-et-mongodb/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


        
            <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2016 Pierre PIRONIN. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="3">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/lava-jug-bigdata-et-integration-en-entreprise/"  data-tooltip="Lava JUG - Bigdata et intégration en entreprise">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PRÉCÉDENT</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/lava-jug-soiree-et-workshop-mongodb/" data-tooltip="Lava JUG - Soirée et workshop MongoDB">
                
                    <span class="hide-xs hide-sm text-small icon-mr">SUIVANT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://pierrepironin.fr/docker-et-mongodb/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://pierrepironin.fr/docker-et-mongodb/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://pierrepironin.fr/docker-et-mongodb/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="3">
    <ul class="share-options">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http://pierrepironin.fr/docker-et-mongodb/">
                <i class="fa fa-google-plus"></i><span class="">Partager sur Google Plus</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://pierrepironin.fr/docker-et-mongodb/">
                <i class="fa fa-facebook-official"></i><span>Partager sur Facebook</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http://pierrepironin.fr/docker-et-mongodb/">
                <i class="fa fa-twitter"></i><span>Partager sur Twitter</span>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        <!-- Define author's picture -->


    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="https://www.gravatar.com/avatar/7e1107690f34c749ba1ca5b05b7e18c5?s=110"/>
        
            <h4 id="about-card-name">Pierre PIRONIN</h4>
        
            <h5 id="about-card-bio"><p><em><p>J’ai créé ce blog pour parler de ce qui se passe autour de moi dans le domaine du génie logiciel. <br/>J’exposerai mes devs, mes idées, mes lectures, les faits qui m’intéressent et les événements auxquels je participe.</p> <p>Bonne lecture !</p></em></p>
</h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Artisan développeur</p>

            </h5>
        
        
            <h5 id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                Auvergne, France
            </h5>
        
    </div>
</div>

        
<div id="cover" style="background-image:url('http://res.cloudinary.com/dxjy3rnlz/image/upload/v1478246260/32_qrgujb.png');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/script.min.js"></script>
<!--SCRIPTS END-->

    <script type="text/javascript">
        var disqus_shortname = 'pierrepironin';
        (function() {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>


    <script type="text/javascript">
        (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
                (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
            e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
        })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

        _st('install','SPYDojLAixz-siwDiSoz','2.0.0');
    </script>


</html>
